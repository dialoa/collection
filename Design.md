---
title: Design of the collection filter
author: Julien Dutant
date: July 2021
---

# Goal

Given a master file, put together chapter sources and templates into a volume and (optionally) offprints (of all/selected chapters), in various output formats (PDF, epub, jats-xml, html). The command should be something like:

```bash
pandoc -L collection.lua master.md <options>
```
## Inputs

* *Master file*. `master.md`
* *Source files*. `chapter1.md`, etc. Targeting `md` but we could leave the format open.
* (?) Markdown bits included in the source file. (not necessarily to support this)
* Chapter-in-book template(s)/filter(s)/defaults: chap-in-book.latex, chap-in-book.jats, … chap-in-book.lua. (in pple could be several ones, e.g. depending whether the chap is an article or a book review or a preface)
* Chapter-in-book defaults: *if* the filter runs pandoc on the chapters (pandoc.pipe(‘pandoc’…, chapter-string) rather than pandoc.read(chapter) ), then chap-in-book.yaml defaults . 
* Book template(s)/filters(s): book.latex, book.epub, book.lua.
* Chapter-offprint templates(s)/filter(s): same as above, but for printing a chapter on its own 
* Local filters: filters applied to all/some of the chapters. (E.g. in dialectica, filters that handle various formatting elements: first-line-indent, columns, recursive-citeproc, pandoc-crossref …)
* Global filters: filters applied to the complete book. (Some formatting filters could be here instead, e.g. first-line-indent; but not recursive-citeproc)
* Local media: for each chapter, its media files (images…) plus any generated media files (images for LaTeX code that MathJAX can’t handle)
* Global media: same but for the book







### Goal

Given a master file, source files for every chapter, and a bunch of filters and templates, generate all

Goal:
Run “pandoc -L collection.lua master.md [options]” one or several times and you get all your outputs.

Inputs:
-   Source files: master.md, chap-1.md etc


Command specification: two main options. (Terminology: when you run ‘pandoc -L collection.lua’ we call the pandoc instance that runs collection.lua the “parent” instance of Pandoc; if collection.lua calls pandoc with pandoc.pipe or pandoc.utils.run_json_filter we call these “child” instances of Pandoc)

OPTION 1: PARENT, parent handles the book output/all output. We run:
Pandoc -L collection.lua master.md -o book.pdf
And the filter puts together a master AST document, which the *parent* turns into book.pdf. On that option, *global filters* are specified when running the command above:
Pandoc -L collection.lua master.md -d book-defaults.yaml -o book.pdf
Where book-defaults.yaml can specify various filters, LaTeX engine etc. 

Sub-options: how do we get offprints? Are they a side-product of the book command? Or do we run the same command again, but specifying that we want a specific chapter:
Pandoc -L collection.lua master.md -M offprint=1 -d offprint.yaml -o chapter-1.pdf

OPTION 2 CHILDREN, children handles the book output. We run:
Pandoc -L collection.lua master.md
The command runs the filter, which calls one or more *child* pandoc processes to generate the book (and possibly offprints). The filter then returns and empty document, which Pandoc outputs either as html in stdin or in a sink file (sink.pdf).

In that option, filters and defaults for the book aren’t passed on the command line, but through master.md metadata.e.g.
Collection:
  Defaults: default file
  Filters:
-   Global-filter-1.lua
-   Global-filter-2.lua
  Templates:
-   book-template.latex 
-   …

Sub-options for option 2: how do we pass the desired output format?

Sub-option 2a: SINK OUTPUT. We use Pandoc’s FORMAT variable. So our command must be:
Pandoc -L collection.lua master.md -o sink.pdf
Where sink.pdf will be an empty pdf that we discard (| rm sink.pdf); the actual pdf is generated by a child pandoc process of collection.lua. 

Sub-option 2b: OUTPUT FORMAT METAVARIABLE. We use a meta-variable to tell collection.lua which format(s) to output. To print out all formats (PDF, html, JATS) we do:
Pandoc -L collection.lua master.md
To print out PDF we do:
Pandoc -L collection.lua master.md -M output-format=pdf
Important note: I’ve made a test, the variable FORMAT can be set within a filter. Pandoc will ignore the modification (it will still output html is that’s what was requested on the command line), but within the filter FORMAT can have any value we want. This means that if chapter formatting is done by user functions called within collection.lua (with mod.require), users can still write their functions like standard filters using the FORMAT. 

COMPARISON OF OPTIONS 1 AND 2
-   Option 2 gives collection.lua more power and flexibility. The filter knows everything about the final book, including which global filters are meant to be applied. It can generate all output formats at once (with sub-option 2b). It can do a dry run to get page numbers in PDF if needed. 
-   Option 1 is leaner and probably requires less coding. 
-   Option 2 separates tasks well. Collection.lua’s job is essentially to run child pandoc processes. All the rest can be left to user’s filters / templates. 
